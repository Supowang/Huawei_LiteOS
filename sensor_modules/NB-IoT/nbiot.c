#include "nbiot.h"
#include "usart.h"
#include "hexstring.h"
#include <stdlib.h>
#include <string.h>
/***************************************************************
* 文件名称: nbiot
* 作    者: 物联网俱乐部
* 版    本: V1.0
* 编写日期: 2018-12-01
* 功    能: NB数据收发
****************************************************************
* 硬件平台: 本例程配套物联网俱乐部EVB_L1开发板使用
* 淘    宝: iot-club.taobao.com、https://shop449662000.taobao.com
* 论    坛: www.iot-club.cn 、www.iotclub.net
****************************************************************/
static char cmdSend[512];

/***************************************************************
* 函数名称: NB_SendCmd
* 说    明: NB发送数据
* 参    数: uint8_t *cmd，需要发送的命令
*			uint8_t *result，期望获得的结果
*			uint32_t timeOut，等待期望结果的时间
*			uint8_t isPrintf，是否打印Log
* 返 回 值: ret，返回值
***************************************************************/
int NB_SendCmd(uint8_t *cmd,uint8_t *result,uint32_t timeOut,uint8_t isPrintf)
{
	int ret=0;
	memset(USART2_RX_BUF,0,strlen((const char *)USART2_RX_BUF));//清除缓存
	if(isPrintf)
		printf("MCU-->>NB: %s\r\n",cmd);
	HAL_UART_Transmit(&huart2, cmd, strlen((const char *)cmd), timeOut);
	HAL_Delay(500);
	while(1)
	{
		if(strstr((const char *)USART2_RX_BUF,(const char *)result))
		{
			ret = 0;
			break;
		}
		else
		{
 			HAL_UART_Transmit(&huart2, cmd, strlen((const char *)cmd), timeOut);
			USART2_RX_LEN = 0;
			HAL_Delay(timeOut);
		}
	}
	if(isPrintf)
		printf("NB-->>MCU: %s\r\n",USART2_RX_BUF);
	HAL_Delay(timeOut);
	USART2_RX_LEN = 0;
	return ret;
}

/***************************************************************
* 函数名称: NB_SendCmd_Mul
* 说    明: NB发送数据，返回值有多个
* 参    数: uint8_t *cmd，需要发送的命令
*						uint8_t *result，期望获得的结果1
*						uint8_t *result，期望获得的结果2
*						uint32_t timeOut，等待期望结果的时间
*						uint8_t isPrintf，是否打印Log
* 返 回 值: ret，返回值
***************************************************************/
int NB_SendCmd_Mul(uint8_t *cmd,uint8_t *result1,uint8_t *result2,uint32_t timeOut,uint8_t isPrintf)
{
	int ret=0;
	memset(USART2_RX_BUF,0,strlen((const char *)USART2_RX_BUF));//清除缓存
	if(isPrintf)
		printf("MCU-->>NB: %s\r\n",cmd);
	HAL_UART_Transmit(&huart2, cmd, strlen((const char *)cmd), timeOut);
	HAL_Delay(100);
	while(1)
	{
		if(strstr((const char *)USART2_RX_BUF,(const char *)result1) 
			||strstr((const char *)USART2_RX_BUF,(const char *)result2))
		{
			ret = 0;
			break;
		}
		else
		{
			HAL_UART_Transmit(&huart2, cmd, strlen((const char *)cmd), timeOut);
			HAL_Delay(timeOut);
		}
	}
	if(isPrintf)
		printf("NB-->>MCU: %s\r\n",USART2_RX_BUF);
	HAL_Delay(timeOut);
	USART2_RX_LEN = 0;
	return ret;
}

/***************************************************************
* 函数名称: NB_InitConnect
* 说    明: NB初始化入网过程
* 参    数: 无
* 返 回 值: 无
***************************************************************/
void NB_InitConnect(void)
{
	NB_SendCmd((uint8_t *)"AT+CFUN?\r\n",(uint8_t *)"OK",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CGSN=1\r\n",(uint8_t *)"OK",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CIMI\r\n",(uint8_t *)"OK",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CGATT=1\r\n",(uint8_t *)"OK",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CGATT?\r\n",(uint8_t *)"+CGATT:1",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CSQ\r\n",(uint8_t *)"OK",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+COPS?\r\n",(uint8_t *)"+COPS:0,2,\"46011\"",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CEREG=1\r\n",(uint8_t *)"OK",DefaultTimeout,1);
	NB_SendCmd((uint8_t *)"AT+CEREG?\r\n",(uint8_t *)"+CEREG:1,1",DefaultTimeout,1);
}

/***************************************************************
* 函数名称: NB_SendMsgToServer
* 说    明: NB发送消息到服务器
* 参    数: *msg，要发送的数据（String形式）
* 返 回 值: 无
***************************************************************/
void NB_SendMsgToServer(uint8_t *msg)
{
	//例：AT+NMGS=len,msg
	memset(cmdSend,0,sizeof(cmdSend));
	uint8_t len = 0;
	char msgLen[4]={0};
	len = strlen((const char *)msg)/2;
	DecToString(len, msgLen);
	strcat(cmdSend,"AT+NMGS=");
	strcat(cmdSend,msgLen);
	strcat(cmdSend,",");
	strcat(cmdSend,(const char *)msg);
	strcat(cmdSend,"\r\n");
	NB_SendCmd((uint8_t *)cmdSend,(uint8_t *)"OK",DefaultTimeout,1);	
}
/***************************************************************
* 函数名称: NB_SetCDPServer
* 说    明: NB设置CDP服务器
* 参    数: *ncdpIP，要发送的服务器（平台）的IP地址
*			*port，要发送的服务器（平台）的端口号
* 返 回 值: 无
***************************************************************/
void NB_SetCDPServer(uint8_t *ncdpIP,uint8_t *port)
{
	//例：AT+NCDP=ncdpIP,port
	memset(cmdSend,0,sizeof(cmdSend));
	strcat(cmdSend,"AT+NCDP=");	
	strcat(cmdSend,(const char *)ncdpIP);
	strcat(cmdSend,",");
	strcat(cmdSend,(const char *)port);
	strcat(cmdSend,"\r\n");
	NB_SendCmd((uint8_t *)cmdSend,(uint8_t *)"OK",DefaultTimeout,1);
}

/***************************************************************
* 函数名称: NB_ReceiveMsg
* 说    明: NB从服务器接收数据
* 参    数: msgReceive,NB接收到的数据,该参数传入时请先分配好内存空间
* 返 回 值: SUCCESS，接收成功
*			ERROR，接收失败或无接收数据
***************************************************************/
uint8_t NB_ReceiveMsg(uint8_t *msgReceive)
{
	//例：+NNMI:2,4F4E
	char *pos1;
	pos1 = strstr((char *)USART2_RX_BUF,"+NNMI:");
	if(pos1)
	{
		HAL_Delay(500);
		char *pos2;
		uint8_t msgReceiveLen;
		msgReceiveLen = atoi(pos1+6);
		printf("NET-->>NB: %s \r\n",USART2_RX_BUF);		
		pos2 = strstr((char*)USART2_RX_BUF,",");
		memcpy(msgReceive,pos2+1,msgReceiveLen*2);	//pos2指向的是“,”  pos2+1指向的是数据
		memset(USART2_RX_BUF,0,USART2_RX_LEN);
		USART2_RX_LEN = 0;
		return SUCCESS;
	}
	return ERROR;
}
